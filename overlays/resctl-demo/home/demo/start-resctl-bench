#!/bin/bash
# Copyright Â© 2020 Collabora Ltd.
# SPDX-License-Identifier: MIT

OUTPUT_DIR="/mnt/results"

# make sure base dir perm matches what resctl-demo would create
RD_DIR="/var/lib/resctl-demo"
sudo mkdir -p ${RD_DIR}
sudo chown root.sudo ${RD_DIR}
sudo chmod u+w,g+ws ${RD_DIR}

echo ""
echo ""
echo "Starting resctl-bench..."
sleep 5

# show mount failed dialog - loop until user plugs in disk
while : ; do
  sudo mkdir -p "$OUTPUT_DIR"
  sudo mount PARTLABEL=results "$OUTPUT_DIR"
  if [ $? = 0 ] ; then
    break
  fi

  dialog --clear \
    --backtitle "resctl-bench" \
    --title "Insert flasher USB" \
    --yesno "Could not mount flasher USB. Please connect flasher USB to the machine and press enter to retry.\n\nChoose no to shutdown machine." \
    20 0
  if [ $? != 0 ] ; then
      echo "Operation cancelled by user. Shutting down."
      sleep 5
      sudo shutdown -h now
  fi
  clear
done

# TODO figure out block device & build filename from model /sys/block/*/device/model
TIMESTAMP=$(date "+%Y_%m_%d-%H_%M_%S")
FILENAME="resctl-bench-result_$TIMESTAMP"
RESULT_JSON="$OUTPUT_DIR/$FILENAME.json.gz"
RESULT_SUMMARY="$OUTPUT_DIR/$FILENAME.txt"
RESULT_PDF="$OUTPUT_DIR/$FILENAME.pdf"
echo "Saving result to $RESULT_JSON"

# Create benchmark using resctl-bench
sudo resctl-bench -r "$RESULT_JSON" run iocost-tune

if [ $? != 0 ] ; then
  echo "resctl-bench failed."
  echo "launching shell to allow investigation..."
  bash
else
  # Silently convert results to PDF/TXT
  sudo resctl-bench -r "$RESULT_JSON" format iocost-tune:pdf=$RESULT_PDF >/dev/null
  sudo resctl-bench -r "$RESULT_JSON" format | sudo tee "$RESULT_SUMMARY" >/dev/null

  echo "resctl-bench finshed successfully."
  echo "Result saved on USB stick as $FILENAME"
fi

# unmount usb stick
sudo umount "$OUTPUT_DIR"
echo ""
echo ""
read -p "Press return to shutdown computer..."
sudo shutdown -h now
